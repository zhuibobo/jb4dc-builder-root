<!DOCTYPE html><html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"><head><meta charset="UTF-8"><title>Title1</title><title>JBuild4D</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script type="text/javascript" src="../../../Js/External/JQuery-3.4.1/jquery-3.4.1.min.js"></script><script type="text/javascript" src="../../../Js/External/VUE-2.6.10/vue.js"></script><script type="text/javascript" src="../../../Js/External/IView-4.X/dist/iview.min.js"></script><script type="text/javascript" src="../../../Js/External/JQuery-UI-1.12.1/jquery-ui.js"></script><script type="text/javascript" src="../../../Js/External/ZTree-3.5.40/js/jquery.ztree.all.js"></script><script type="text/javascript" src="../../../Js/External/Perfect-Scrollbar-V1.4.0/perfect-scrollbar.js"></script><script type="text/javascript" src="../../../Js/JBuild4DCLib.js?refVersion=1607561961216"></script><script type="text/javascript" src="../../../Js/UIEXComponent.js?refVersion=1607561961216"></script><script type="text/javascript" src="../../../Js/VueEXComponent.js?refVersion=1607561961216"></script><script type="text/javascript" src="../../../Js/External/Turf/turf.min.js"></script><link rel="stylesheet" type="text/css" href="../../../Themes/Default/Css/JBuild4DC.css?refVersion=1607561961216"><link rel="stylesheet" type="text/css" href="../../../Themes/Default/IView-4.X/iview.css"><link rel="stylesheet" type="text/css" href="../../../Themes/Default/JQueryUI/jquery-ui.css"><link rel="stylesheet" type="text/css" href="../../../Themes/Default/JQueryUI/jquery-ui-important.css"><link rel="stylesheet" type="text/css" href="../../../Themes/Default/ZTree/zTreeStyle/zTreeStyle.css"><link rel="stylesheet" type="text/css" href="../../../Themes/Default/Grid/Css/JBuild4DCGridSystem.css?refVersion=1607561961216"><link rel="stylesheet" type="text/css" href="../../../Js/External/Perfect-Scrollbar-V1.4.0/perfect-scrollbar.css"><style></style></head><body><div id="gridManager" class="list-2column"><div class="left-outer-wrap" style="width:250px"><div class="inner-wrap"><div class="tool-bar-wrap"></div><div style="position:absolute;top:40px;bottom:20px;overflow:auto;width:245px"><ul id="zTreeUL" class="ztree" style="width:100%"></ul></div></div></div><div class="right-outer-wrap iv-list-page-wrap" style="padding:10px;left:260px"><tabs><tab-pane label="网格地图"><div id="map-wrap-grid" class="map-wrap-grid" style=""><div id="baidu_map_grid" style="height:100%"></div><div class="map-operation-button-wrap" style="display:none"><div class="map-operation-button"><input id="cb_show_same_level_grid_path" type="checkbox" style="width:30px;height:30px;margin:9px 9px" title="显示同级网格图形"></div><div class="map-operation-button map-operation-button-add" @click="addEmptyAreaInMap" title="添加区域"></div><div class="map-operation-button map-operation-button-clear" @click="clearCurrentGridEditArea" title="清空区域"></div><div class="map-operation-button map-operation-button-save" @click="saveThisGridPath" title="保存"></div></div></div></tab-pane><tab-pane label="网格信息"><div class="general-edit-page-wrap"><table class="light-gray-table" cellpadding="0" cellspacing="0" border="0"><colgroup><col style="width:100px"><col></colgroup><tbody><tr><td class="label">编码：</td><td style="text-align:center"><input type="text" v-model="gridInfoEntity.gridCode"></td></tr><tr><td class="label">简介：</td><td colspan="5"><textarea rows="8" v-model="gridInfoEntity.gridContent"></textarea></td></tr><tr><td class="label">备注：</td><td colspan="5"><textarea rows="4" v-model="gridInfoEntity.gridRemark"></textarea></td></tr></tbody></table><div><div style="float:right"><button-group><i-button type="primary" @click="saveGridInfo" icon="md-checkmark">保存</i-button><i-button @click="clearGridInfo" icon="md-close">清空</i-button></button-group></div></div></div></tab-pane><tab-pane label="成员"><i-table :height="member.listHeight" stripe border :columns="member.columnsConfig" :data="member.tableData" class="iv-list-table" :highlight-row="true"></i-table></tab-pane></tabs></div></div><script>var gridManager=new Vue({el:"#gridManager",mounted:function(){this.initTree(),BaiduMapUtility.LoadJsCompleted("gridManager.initBaiduMap"),$("#map-wrap-grid").height(PageStyleUtility.GetPageHeight()-80),$("#cb_show_same_level_grid_path").click(function(){$(this).prop("checked")?gridManager.showSameLevelGridPath(!0):gridManager.showSameLevelGridPath(!1)})},data:{acInterface:{getOrganAndUserData:"/Rest/Grid/SSOProxy/OrganAndUser/GetOrganAndUserData",saveMapPath:"/Rest/Grid/GridInfo/GridInfoMain/SaveGridMapPath",getGridInfo:"/Rest/Grid/GridInfo/GridInfoMain/GetGridInfo",getSameLevelGrid:"/Rest/Grid/GridInfo/GridInfoMain/GetSameLevelGrid",saveGridInfo:"/Rest/Grid/GridInfo/GridInfoMain/SaveGridInfo"},map:{mapObj:null,selectedLngLat:null,editObjs:[],viewObjs:[]},OrganTree:{treeSetting:{async:{enable:!0,url:""},data:{key:{name:"organName"},simpleData:{enable:!0,idKey:"organId",pIdKey:"organParentId",rootId:0}},callback:{onClick:function(e,t,a){gridManager.treeNodeSelected(e,t,a)},onAsyncSuccess:function(e,t,a,i){gridManager.OrganTree.treeObj.expandAll(!0)}}},treeIdFieldName:"roleGroupId",treeObj:null,treeSelectedNode:null},member:{allMemberData:[],listHeight:ListPageUtility.DefaultListHeight(),tableData:[],columnsConfig:[{title:"用户名",key:"userName",align:"center"},{title:"账号",key:"userAccount",align:"center"},{title:"联系电话",key:"userPhoneNumber",align:"center"}]},gridInfoEntity:{gridCode:"",gridOrganId:"",gridRemark:"",gridParentId:"",gridContent:"",gridMapPath:""}},methods:{initBaiduMap:function(){this.map.mapObj=new BMapGL.Map("baidu_map_grid"),this.map.mapObj.centerAndZoom(new BMapGL.Point(114.54200132645097,22.754142795907825),16),this.map.mapObj.enableScrollWheelZoom(!0),this.map.mapObj.addEventListener("click",function(e){gridManager.map.selectedLngLat=e.latlng,console.log(e.latlng)}),$(".map-operation-button-wrap").show()},addToEditObjs:function(e){this.map.editObjs.push(e),e.obj.enableEditing()},addToViewObjs:function(e){this.map.viewObjs.push(e)},addEmptyAreaInMap:function(){if(null!=this.OrganTree.treeSelectedNode)if(null!=this.map.selectedLngLat){var e=gridManager.map.selectedLngLat,t=new BMapGL.Polygon([new BMapGL.Point(e.lng,e.lat),new BMapGL.Point(e.lng,e.lat+.001),new BMapGL.Point(e.lng+.001,e.lat+.001),new BMapGL.Point(e.lng+.001,e.lat)],{strokeColor:"blue",strokeWeight:2,strokeOpacity:.8,fillColor:"#cd6155",fillOpacity:.5});this.map.mapObj.addOverlay(t),this.addToEditObjs({type:"Polygon",obj:t})}else DialogUtility.ToastMessage(this,"请先在地图上选择初始位置!");else DialogUtility.ToastMessage(this,"请先选择行政区划!")},showSameLevelGridPath:function(e){if(e){if(null==this.OrganTree.treeSelectedNode)return void DialogUtility.ToastMessage(this,"请先选择行政区划!");var t=this.OrganTree.treeSelectedNode;AjaxUtility.Get(this.acInterface.getSameLevelGrid,{parentId:t.organParentId,excludeId:t.organId},function(e){if(console.log(e),e.success)for(var t=0;t<e.data.length;t++){var a=e.data[t],i=this.OrganTree.treeObj.getNodesByParam("organId",a.gridId)[0];StringUtility.IsNotNullOrEmpty(a.gridMapPath)&&this.drawSingleGridPath(a.gridMapPath,!1,i.organName)}},this)}else{for(var a=0;a<this.map.viewObjs.length;a++)this.map.mapObj.removeOverlay(this.map.viewObjs[a].obj),$("#cb_show_same_level_grid_path").prop("checked",!1);this.map.viewObjs=[]}},clearCurrentGridEditArea:function(){this.OrganTree.treeSelectedNode;for(var e=0;e<this.map.editObjs.length;e++)this.map.mapObj.removeOverlay(this.map.editObjs[e].obj);this.map.editObjs=[]},initTree:function(){var i=this;AjaxUtility.Get(this.acInterface.getOrganAndUserData,{},function(e){if(console.log(e),e.success){var t=e.data.ALLOrganMinProp;if(null!=t&&0<t.length)for(var a=0;a<t.length;a++)"0"!=t[a].organId&&(t[a].icon="../../../Themes/Png16X16/icons8-registry-editor-16.png");i.member.allMemberData=e.data.ALLUserMinProp,i.OrganTree.treeObj=$.fn.zTree.init($("#zTreeUL"),i.OrganTree.treeSetting,t),i.OrganTree.treeObj.expandAll(!0)}else DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},e.message,function(){})},this)},treeNodeSelected:function(e,t,a){this.OrganTree.treeSelectedNode=a,this.map.selectedLngLat=null,this.getGridInfo(a),this.bindOrganMember(a)},saveThisGridPath:function(){if(null!=this.OrganTree.treeSelectedNode){for(var e=this.OrganTree.treeSelectedNode,t=[],a=0;a<this.map.editObjs.length;a++)t.push({type:this.map.editObjs[a].type,path:this.map.editObjs[a].obj.getPath()});var i=JsonUtility.JsonToString(t);AjaxUtility.Post(this.acInterface.saveMapPath,{organId:e.organId,gridMapPath:i,parentId:e.organParentId},function(e){e.success&&DialogUtility.AlertText("保存成功!")})}else DialogUtility.ToastMessage(this,"请先选择行政区划!")},drawSingleGridPath:function(e,t,a){for(var i=JsonUtility.StringToJson(e),r=0;r<i.length;r++){var n=i[r];if("Polygon"==n.type){var o=n.path;console.log(o);for(var d=[],l=0;l<o.length;l++)d.push(new BMapGL.Point(o[l].lng,o[l].lat));var s=new BMapGL.Polygon(d,{strokeColor:"blue",strokeWeight:2,strokeOpacity:.8,fillColor:"#CD6155",fillOpacity:.5});if(this.map.mapObj.addOverlay(s),t)this.addToEditObjs({type:"Polygon",obj:s});else{this.addToViewObjs({type:"Polygon",obj:s});var g=BaiduMapUtility.GetLatLngCenter(d),h=new BMapGL.Point(g.lng,g.lat),p=new BMapGL.Label(a,{position:h,offset:new BMapGL.Size(-10,-10)});this.map.mapObj.addOverlay(p),this.addToViewObjs({type:"text",obj:p})}}}},getGridInfo:function(e){this.clearCurrentGridEditArea(),this.showSameLevelGridPath(!1),AjaxUtility.Get(this.acInterface.getGridInfo,{organId:e.organId},function(e){console.log(e),e.success&&(e.data?(this.gridInfoEntity=e.data,StringUtility.IsNotNullOrEmpty(e.data.gridMapPath)&&this.drawSingleGridPath(e.data.gridMapPath,!0,"")):this.gridInfoEntity={gridCode:"",gridOrganId:"",gridRemark:"",gridParentId:"",gridContent:"",gridMapPath:""})},this)},saveGridInfo:function(){var e=this.OrganTree.treeSelectedNode;null!=e?AjaxUtility.Post(this.acInterface.saveGridInfo,{organId:e.organId,gridCode:this.gridInfoEntity.gridCode,gridContent:this.gridInfoEntity.gridContent,gridRemark:this.gridInfoEntity.gridRemark,gridParentId:e.organParentId},function(e){e.success&&DialogUtility.AlertText("保存成功!")}):DialogUtility.ToastMessage(this,"请先选择组织机构!")},clearGridInfo:function(){},bindOrganMember:function(e){this.member.tableData=[];for(var t=0;t<this.member.allMemberData.length;t++)this.member.allMemberData[t].userOrganId==e.organId&&this.member.tableData.push(this.member.allMemberData[t])}}})</script></body></html>